---
AWSTemplateFormatVersion: '2010-09-09'
Description: S3 resource stack creation using Amplify CLI
Parameters:
  CallsOutQueueArn:
    Type: String
  storagescreenshotsBucketName:
    Type: String
  env:
    Type: String
  authallscreens59d1a2d8UserPoolId:
    Type: String
  authuserPoolGroupsteachersGroupRole:
    Type: String
  authuserPoolGroupsstudentsGroupRole:
    Type: String
  interactionsvirtualtutorlexBotName:
    Type: String
Conditions:
  ShouldNotCreateEnvResources:
    Fn::Equals:
    - Ref: env
    - NONE
Resources: 
  studentsGroupPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: students-group-extra-policy
      Roles:
      - Fn::Join:
        - ''
        - - Ref: authallscreens59d1a2d8UserPoolId
          - "-studentsGroupRole"
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - sumerian:ViewRelease
          - polly:DescribeVoices
          - polly:GetLexicon
          - polly:GetSpeechSynthesisTask
          - polly:ListLexicons
          - polly:ListSpeechSynthesisTasks
          - polly:SynthesizeSpeech
          - transcribe:StartStreamTranscriptionWebSocket
          - comprehend:DetectSentiment
          - comprehend:DetectEntities
          - comprehend:DetectDominantLanguage
          - comprehend:DetectSyntax
          - comprehend:DetectKeyPhrases
          - translate:TranslateText
          Resource:
          - "*"          
        - Effect: Allow
          Action:
          - lex:PostContent
          - lex:PostText
          Resource:
          - !Sub 'arn:aws:lex:${AWS::Region}:${AWS::AccountId}:bot:${interactionsvirtualtutorlexBotName}:*'
          
  teachersGroupPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: teacher-group-extra-policy
      Roles:
        - !Sub '${authallscreens59d1a2d8UserPoolId}-teachersGroupRole'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - !Sub 'arn:aws:s3:::${storagescreenshotsBucketName}'
        - Effect: Allow
          Action:
            - sqs:SendMessage
          Resource:
            - !Ref CallsOutQueueArn           
        - Effect: Allow
          Action:
            - cognito-idp:ListUsersInGroup
            - cognito-idp:GetUser
          Resource:
            - !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${authallscreens59d1a2d8UserPoolId} 

Outputs:
  CallsOutQueueArn:
    Value: !Ref CallsOutQueueArn
